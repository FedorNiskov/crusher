# Общее описание

Этот пример демонстрирует фаззинг модуля UEFI 
на основе полносистемной эмуляции с помощью Nyx.

# Описание целевого кода

Целевым модулем UEFI в этом примере является GRUB
(https://git.savannah.gnu.org/git/grub.git).
Целевой код в данном модуле - парсер интерпретатора консоли -
функция `grub_script_parse`.
Начальная точка - перед вызовом этой функции,
конечные точки - после возврата из функции,
чтение следующей порции ввода (`grub_normal_read_line`),
возникновение ошибки (`grub_print_error`).

# Сборка

Для сборки следует использовать Docker-контейнер с Ubuntu 22.04:

```
docker run -it --privileged ubuntu:22.04 /bin/bash
```

С помощью команды `docker cp` следует поместить папку `building` в корень контейнера,
затем внутри перейти в неё, запустить `./build.sh`
и забрать на хост полученные файлы образа - `ovmf.fd` (основа UEFI) и `boot.img` (носитель с GRUB).

При сборке командой `./build.sh clean` будет собран чистый образ - без правок для Nyx.
Его можно запустить в обычной Qemu командой:

```
qemu-system-x86_64 -enable-kvm -bios ./ovmf.fd -cdrom ./boot.img -serial mon:stdio -nographic
```

# Общая схема фаззинга

Здесь используется стандартная схема для Nyx.
В целевой код вставляются гипервызовы Nyx API
для конфигурации, начальных/конечных точек, входных данных и покрытия
(см. `building/grub_nyx_patch.txt`).
В начальной точке делается снимок, затем для каждого очередного образца входных данных
выполняется эмуляция до конечной точки, данные при этом подаются в целевую функцию.
Покрытие в данном примере собирается с помощью аппаратной поддержки Intel-PT
(должны быть выполнены требования Nyx на процессор и KVM).

# Запуск фаззинга

Фаззер запускается следующей командой:

```
rm -rf out; /path/to/crusher/bin_x86-64/fuzz_manager --start 4 --eat-cores 1 --dse-cores 0 -i ./in -o ./out -I nyx -t 3000 -- ./target
```

Перед запуском укажите актуальные пути в `target/config.ron`.
Эта команда запускает указанное количество экземпляров фаззинга;
каждый экземпляр запускает Qemu, достигается начальная точка,
затем выполняется фаззинг по вышесказанной схеме.
При корректном запуске данного примера ожидается
прирост количества путей и генерация соответствующих входных данных.

