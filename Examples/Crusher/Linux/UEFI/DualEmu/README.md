# Общее описание

Этот пример демонстрирует фаззинг модуля UEFI 
на основе частичной эмуляции с помощью Dual-Emu.

# Описание целевого кода

Целевым модулем UEFI в этом примере является GRUB
(https://git.savannah.gnu.org/git/grub.git).
Целевой код в данном модуле - парсер интерпретатора консоли -
функция `grub_script_parse`.
Начальная точка - вход в эту функцию,
конечные точки - возврат из функции,
чтение следующей порции ввода (`grub_normal_read_line`),
возникновение ошибки (`grub_print_error`).

# Сборка

Для сборки следует использовать Docker-контейнер с Ubuntu 22.04:

```
docker run -it --privileged ubuntu:22.04 /bin/bash
```

С помощью команды `docker cp` следует поместить папку `building` в корень контейнера,
затем внутри перейти в неё, запустить `./build.sh`
и забрать на хост полученные файлы образа - `ovmf.fd` (основа UEFI) и `boot.img` (носитель с GRUB).
В процессе сборки применяется патч - в код для удобства добавлена отладочная печать
(адреса функций).
Собранный образ можно запустить в Qemu командой:

```
qemu-system-x86_64 -enable-kvm -bios ./ovmf.fd -cdrom ./boot.img -serial mon:stdio -nographic -s
```

Для снятия снимка нужно подключиться к Qemu в GDB,
поставить точку останова на целевую функцию,
дойти до неё (ввести любые символы в консоль GRUB и нажать Enter),
считать регистры и сохранить память.
Т.е. используются следующие команды GDB:

```
target remote :1234
break * 0x39AAA52
continue

info registers
dump memory mem.bin 0x00000000 0x08000000
```

# Общая схема фаззинга

Здесь основой фаззинга является частичная эмуляция -
выполнение интересующего фрагмента кода из начального состояния
на основе скрипта пользователя.
Снимок начального состояния (регистры и память) сохранён в папке `dump`.
Этот снимок получен с помощью эмулятора Qemu.
Пользовательский скрипт `script.py` использует API Dual-Emu,
чтобы указать снимок, конечные точки, входные данные и запустить эмуляцию.

# Запуск

Для запуска примера не требуется компиляция ПО и получение снимка -
в файлах примера уже присутствует готовый к запуску снимок и всё необходимое.

Запуск эмуляции (на входных данных из файла `input`):

```
/path/to/python3 ./script.py --qiling -i ./input
```

Запуск фаззинга (наблюдается постепенный рост покрытия):

```
rm -rf out; /path/to/crusher/bin_x86-64/fuzz_manager --start 4 --eat-cores 1 --dse-cores 0  -i ./in -o ./out -I dualemu -T dualemu -t 3000 -- ./script.py
```

